// https://observablehq.com/@d3/bivariate-choropleth@422
function _1(md){return(
  md`# Bivariate Choropleth`
)}

function _colors(schemes){return(
  //Inputs.select(new Map(schemes.map(s => [s.name, s.colors])), {key: "GnBu", label: "Color scheme"})
  schemes[2].colors
)}

function _chooseYear(Inputs,years){return(
  Inputs.select(new Map(years.map(s => [s.year, s.year])), {key: "2023", label: "Year"})
)}

function _chart(d3,legend,topojson,us,color,data,path,states,format)
{
  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, 975, 610]);

  svg.append(legend)
    .attr("transform", "translate(870,450)");

  svg.append("g")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .join("path")
    .attr("fill", d => color(data.get(d.id)))
    .attr("d", path)
    .append("title")
    .text(d => `${d.properties.name}, ${states.get(d.id.slice(0, 2)).name}
${format(data.get(d.id))}`);

  svg.append("path")
    .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
    .attr("fill", "none")
    .attr("stroke", "white")
    .attr("stroke-linejoin", "round")
    .attr("d", path);

  return svg.node();
}


function _legend(DOM,svg,n,d3,colors,data,labels){return(
  () => {
    const k = 24;
    const arrow = DOM.uid();
    return svg`<g font-family=sans-serif font-size=10>
  <g transform="translate(-${k * n / 2},-${k * n / 2}) rotate(-45 ${k * n / 2},${k * n / 2})">
    <marker id="${arrow.id}" markerHeight=10 markerWidth=10 refX=6 refY=3 orient=auto>
      <path d="M0,0L9,3L0,6Z" />
    </marker>
    ${d3.cross(d3.range(n), d3.range(n)).map(([i, j]) => svg`<rect width=${k} height=${k} x=${i * k} y=${(n - 1 - j) * k} fill=${colors[j * n + i]}>
      <title>${data.title[0]}${labels[j] && ` (${labels[j]})`}
${data.title[1]}${labels[i] && ` (${labels[i]})`}</title>
    </rect>`)}
    <line marker-end="${arrow}" x1=0 x2=${n * k} y1=${n * k} y2=${n * k} stroke=black stroke-width=1.5 />
    <line marker-end="${arrow}" y2=0 y1=${n * k} stroke=black stroke-width=1.5 />
    <text font-weight="bold" dy="0.71em" transform="rotate(90) translate(${n / 2 * k},6)" text-anchor="middle">${data.title[0]}</text>
    <text font-weight="bold" dy="0.71em" transform="translate(${n / 2 * k},${n * k + 6})" text-anchor="middle">${data.title[1]}</text>
  </g>
</g>`;
  }
)}

async function _data(d3,FileAttachment){return(
  Object.assign(new Map(d3.csvParse(await FileAttachment("voting-with-population.csv").text(),
    ({FIPSC, MailTurnout, InPersonEDTurnout, TotalActiveVoters}) => [FIPSC, [+(d3.format(".2")(MailTurnout/TotalActiveVoters*100)), +(d3.format(".2")(InPersonEDTurnout/TotalActiveVoters*100)), +MailTurnout], TotalActiveVoters])),
    {title: ["% Mail-in", "" + "% In Person", "Active Voters: "]})
)}

function _years(){return(
  [
    {
      year: "2020"
    },
    {
      year: "2021"
    },
    {
      year: "2022"
    },
    {
      year: "2023"
    }
  ]

)}

function _schemes(){return(
  [
    {
      name: "RdBu",
      colors: [
        "#e8e8e8", "#e4acac", "#c85a5a",
        "#b0d5df", "#ad9ea5", "#985356",
        "#64acbe", "#627f8c", "#574249"
      ]
    },
    {
      name: "BuPu",
      colors: [
        "#e8e8e8", "#ace4e4", "#5ac8c8",
        "#dfb0d6", "#a5add3", "#5698b9",
        "#be64ac", "#8c62aa", "#3b4994"
      ]
    },
    {
      name: "GnBu",
      colors: [
        "#e8e8e8", "#b5c0da", "#6c83b5",
        "#b8d6be", "#90b2b3", "#567994",
        "#73ae80", "#5a9178", "#2a5a5b"
      ]
    },
    {
      name: "PuOr",
      colors: [
        "#e8e8e8", "#e4d9ac", "#c8b35a",
        "#cbb8d7", "#c8ada0", "#af8e53",
        "#9972af", "#976b82", "#804d36"
      ]
    }
  ]
)}

function _labels(){return(
  ["low", "", "high"]
)}

function _n(colors){return(
  Math.floor(Math.sqrt(colors.length))
)}

function _x(d3,data,n){return(
  d3.scaleQuantile(Array.from(data.values(), d => d[0]), d3.range(n))
)}

function _y(d3,data,n){return(
  d3.scaleQuantile(Array.from(data.values(), d => d[1]), d3.range(n))
)}

function _path(d3){return(
  d3.geoPath()
)}

function _color(colors,y,x,n)
{
  return value => {
    if (!value) return "#ccc";
    let [a, b] = value;
    return colors[y(b) + x(a) * n];
  };
}


function _format(data,labels,x,y){return(
  (value) => {
    if (!value) return "N/A";
    let [a, b, c] = value;
    return `${data.title[2]}${c}
${a}${data.title[0]}${labels[x(a)] && ` (${labels[x(a)]})`}
${b}${data.title[1]}${labels[y(b)] && ` (${labels[y(b)]})`}`;
  }
)}


function _states(us){return(
  new Map(us.objects.states.geometries.map(d => [d.id, d.properties]))
)}

function _us(FileAttachment){return(
  FileAttachment("counties-albers-10m.json").json()
)}

export default function defineBivariateChoropleth(runtime, observer) {
  const main = runtime.module();
  function toString() { return this.url; }
  const fileAttachments = new Map([
    ["counties-albers-10m.json", {url: new URL("../../../../sites/default/files/visualizations/us-voting-methods/counties.json", import.meta.url), mimeType: "application/json", toString}],
    ["voting-with-population.csv", {url: new URL("../../../../sites/default/files/visualizations/us-voting-methods/voting-with-population.csv", import.meta.url), mimeType: "text/csv", toString}]
  ]);
  main.builtin("FileAttachment", runtime.fileAttachments(name => fileAttachments.get(name)));
  //main.variable(observer()).define(["md"], _1);
  //main.variable(observer("viewof colors")).define("viewof colors", ["Inputs","schemes"], _colors);
  //main.variable(observer("viewof years")).define("viewof years", ["Inputs","years"], _chooseYear);
  //main.variable(observer("colors")).define("colors", ["Generators", "viewof colors"], (G, _) => G.input(_));
  main.variable().define("colors",["schemes"], _colors);
  main.variable(observer("chart")).define("chart", ["d3","legend","topojson","us","color","data","path","states","format"], _chart);
  main.variable().define("legend", ["DOM","svg","n","d3","colors","data","labels"], _legend);
  main.variable().define("data", ["d3","FileAttachment"], _data);
  main.variable().define("schemes", _schemes);
  main.variable().define("years", _years);
  main.variable().define("labels", _labels);
  main.variable().define("n", ["colors"], _n);
  main.variable().define("x", ["d3","data","n"], _x);
  main.variable().define("y", ["d3","data","n"], _y);
  main.variable().define("path", ["d3"], _path);
  main.variable().define("color", ["colors","y","x","n"], _color);
  main.variable().define("format", ["data","labels","x","y"], _format);
  main.variable().define("states", ["us"], _states);
  main.variable().define("us", ["FileAttachment"], _us);
  return main;
}

